# generated-by: DeepAgent on 2025-11-13
# UPRISE Main CI Pipeline (T8 Implementation)
# Comprehensive CI/CD workflow for the UPRISE monorepo
#
# This workflow runs on pull requests and pushes to main/develop branches
# It includes linting, type checking, testing, and building with optimized caching

name: CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

# Cancel in-progress runs of the same workflow for the same PR
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '22'
  PNPM_VERSION: '9.0.0'

jobs:
  # Job 1: Install dependencies (runs first, other jobs depend on it)
  install:
    name: Install Dependencies
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Enable Corepack
        run: corepack enable

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: |
            **/node_modules
            ~/.cache/Cypress
          key: ${{ runner.os }}-node-modules-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-node-modules-

  # Job 2: Lint all packages
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    needs: install
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Enable Corepack
        run: corepack enable

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Restore node_modules cache
        uses: actions/cache@v4
        with:
          path: |
            **/node_modules
            ~/.cache/Cypress
          key: ${{ runner.os }}-node-modules-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-node-modules-

      - name: Setup Turborepo cache
        uses: actions/cache@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-lint-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-turbo-lint-

      - name: Run ESLint
        run: pnpm run lint

  # Job 3: Type check all packages
  typecheck:
    name: Type Check
    runs-on: ubuntu-latest
    needs: install
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Enable Corepack
        run: corepack enable

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Restore node_modules cache
        uses: actions/cache@v4
        with:
          path: |
            **/node_modules
            ~/.cache/Cypress
          key: ${{ runner.os }}-node-modules-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-node-modules-

      - name: Setup Turborepo cache
        uses: actions/cache@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-typecheck-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-turbo-typecheck-

      - name: Run TypeScript compiler
        run: pnpm run typecheck

  # Job 3.5: Documentation guardrails (structure + forbidden artifacts)
  docs_lint:
    name: Docs Lint
    runs-on: ubuntu-latest
    needs: install
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Enable Corepack
        run: corepack enable

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Restore node_modules cache
        uses: actions/cache@v4
        with:
          path: |
            **/node_modules
            ~/.cache/Cypress
          key: ${{ runner.os }}-node-modules-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-node-modules-

      - name: Run docs lint
        run: pnpm run docs:lint

  # Job 4: Run tests for all apps
  test:
    name: Test Apps
    runs-on: ubuntu-latest
    needs: install
    timeout-minutes: 15

    strategy:
      matrix:
        app: [web, api, socket]
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Enable Corepack
        run: corepack enable

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Restore node_modules cache
        uses: actions/cache@v4
        with:
          path: |
            **/node_modules
            ~/.cache/Cypress
          key: ${{ runner.os }}-node-modules-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-node-modules-

      - name: Setup Turborepo cache
        uses: actions/cache@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-test-${{ matrix.app }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-turbo-test-${{ matrix.app }}-

      # Start PostgreSQL with PostGIS for API tests
      - name: Start PostgreSQL (for API tests)
        if: matrix.app == 'api'
        run: |
          docker run -d \
            --name postgres \
            -e POSTGRES_USER=uprise \
            -e POSTGRES_PASSWORD=uprise \
            -e POSTGRES_DB=uprise_test \
            -p 5432:5432 \
            postgis/postgis:15-3.3
          
          # Wait for PostgreSQL to be ready
          timeout 60 bash -c 'until docker exec postgres pg_isready -U uprise; do sleep 1; done'

      - name: Run Prisma migrations (for API tests)
        if: matrix.app == 'api'
        run: |
          cd apps/api
          DATABASE_URL="postgresql://uprise:uprise@localhost:5432/uprise_test" pnpm prisma migrate deploy

      - name: Run tests for ${{ matrix.app }}
        run: pnpm --filter ${{ matrix.app }} test
        env:
          DATABASE_URL: ${{ matrix.app == 'api' && 'postgresql://uprise:uprise@localhost:5432/uprise_test' || '' }}

      - name: Upload test coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.app }}
          path: apps/${{ matrix.app }}/coverage
          retention-days: 7

  # Job 5: Build all apps
  build:
    name: Build Apps
    runs-on: ubuntu-latest
    needs: [lint, typecheck, test]
    timeout-minutes: 15

    strategy:
      matrix:
        app: [web, api, socket]
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Enable Corepack
        run: corepack enable

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Restore node_modules cache
        uses: actions/cache@v4
        with:
          path: |
            **/node_modules
            ~/.cache/Cypress
          key: ${{ runner.os }}-node-modules-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-node-modules-

      - name: Setup Turborepo cache
        uses: actions/cache@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-build-${{ matrix.app }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-turbo-build-${{ matrix.app }}-

      - name: Build ${{ matrix.app }}
        run: pnpm --filter ${{ matrix.app }} build

      - name: Upload build artifacts
        if: matrix.app == 'web'
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.app }}
          path: apps/${{ matrix.app }}/.next
          retention-days: 7

  # Job 6: Infrastructure policy check (references existing workflow)
  infra-policy:
    name: Infrastructure Policy Check
    runs-on: ubuntu-latest
    needs: install
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Enable Corepack
        run: corepack enable

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Restore node_modules cache
        uses: actions/cache@v4
        with:
          path: |
            **/node_modules
            ~/.cache/Cypress
          key: ${{ runner.os }}-node-modules-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-node-modules-

      - name: Run Infrastructure Policy Check
        run: pnpm run infra-policy-check

      - name: Display help on failure
        if: failure()
        run: |
          echo "❌ Infrastructure Policy Check failed!"
          echo ""
          echo "For more information, see:"
          echo "  • docs/STRATEGY_CRITICAL_INFRA_NOTE.md"
          echo "  • docs/RUNBOOK.md"
          echo "  • apps/web/WEB_TIER_BOUNDARY.md"

  # Job 7: All checks passed
  ci-success:
    name: ✅ All CI Checks Passed
    runs-on: ubuntu-latest
    needs: [lint, typecheck, test, build, infra-policy]
    if: always()

    steps:
      - name: Check all jobs status
        run: |
          if [ "${{ needs.lint.result }}" != "success" ] || \
             [ "${{ needs.typecheck.result }}" != "success" ] || \
             [ "${{ needs.test.result }}" != "success" ] || \
             [ "${{ needs.build.result }}" != "success" ] || \
             [ "${{ needs.infra-policy.result }}" != "success" ]; then
            echo "❌ Some CI checks failed"
            exit 1
          fi
          echo "✅ All CI checks passed successfully!"

      - name: Post status to PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '✅ **CI Pipeline Passed**\n\nAll checks completed successfully:\n- ✅ Linting\n- ✅ Type Checking\n- ✅ Tests\n- ✅ Builds\n- ✅ Infrastructure Policy'
            })
