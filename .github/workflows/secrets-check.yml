# generated-by: DeepAgent on 2025-11-13
# UPRISE Secrets Scanning Workflow (T8 Implementation)
# Scans for accidentally committed secrets, API keys, tokens, and passwords
#
# This workflow helps prevent security vulnerabilities by detecting:
# - API keys and tokens
# - Hardcoded passwords
# - Private keys
# - AWS credentials
# - Database connection strings
# - Other sensitive data

name: Secrets Scan

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run weekly on Sundays at 00:00 UTC
    - cron: '0 0 * * 0'

# Cancel in-progress runs for the same workflow
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  gitleaks:
    name: Scan for Secrets with Gitleaks
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better secret detection

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }} # Optional: for Gitleaks Pro features

  trufflehog:
    name: Scan for Secrets with TruffleHog
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: TruffleHog OSS
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug --only-verified

  custom-patterns:
    name: Custom Secret Pattern Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Scan for common patterns
        run: |
          echo "üîç Scanning for common secret patterns..."
          
          # Initialize error flag
          ERRORS_FOUND=0
          
          # Function to report findings
          report_finding() {
            echo "‚ùå FOUND: $1"
            echo "   File: $2"
            echo "   Line: $3"
            echo ""
            ERRORS_FOUND=1
          }

          # Common excludes for repo-local pattern scans.
          # Dedicated scanners (Gitleaks/TruffleHog) still scan workflows/history.
          GREP_EXCLUDES=(
            --exclude-dir=node_modules
            --exclude-dir=.git
            --exclude-dir=.next
            --exclude-dir=.turbo
            --exclude-dir=.github
            --exclude-dir=legacy
            --exclude=*.md
          )
          
          # Scan for AWS credentials
          if grep -rn "AKIA[0-9A-Z]{16}" "${GREP_EXCLUDES[@]}" .; then
            report_finding "AWS Access Key" "$(grep -rn "AKIA[0-9A-Z]{16}" "${GREP_EXCLUDES[@]}" . | head -1)"
          fi
          
          # Scan for generic API keys
          if grep -rn "api[_-]?key['\"]?\s*[:=]\s*['\"][a-zA-Z0-9]{32,}['\"]" "${GREP_EXCLUDES[@]}" .; then
            report_finding "API Key" "$(grep -rn "api[_-]?key['\"]?\s*[:=]\s*['\"][a-zA-Z0-9]{32,}['\"]" "${GREP_EXCLUDES[@]}" . | head -1)"
          fi
          
          # Scan for private keys
          if grep -rn "BEGIN.*PRIVATE KEY" "${GREP_EXCLUDES[@]}" .; then
            report_finding "Private Key" "$(grep -rn "BEGIN.*PRIVATE KEY" "${GREP_EXCLUDES[@]}" . | head -1)"
          fi
          
          # Scan for database URLs with credentials
          if grep -rn "postgresql://[^:]*:[^@]*@" "${GREP_EXCLUDES[@]}" --exclude=*.yml --exclude=.env.example --exclude=*.test.ts --exclude=*.spec.ts --exclude-dir=test --exclude-dir=__tests__ .; then
            report_finding "Database URL with credentials" "$(grep -rn "postgresql://[^:]*:[^@]*@" "${GREP_EXCLUDES[@]}" --exclude=*.yml --exclude=.env.example --exclude=*.test.ts --exclude=*.spec.ts --exclude-dir=test --exclude-dir=__tests__ . | head -1)"
          fi
          
          # Scan for JWT secrets that aren't example values
          if grep -rn "JWT_SECRET\s*=\s*['\"][^'\"]*['\"]" "${GREP_EXCLUDES[@]}" --exclude=.env.example --exclude=*.yml --exclude=*.test.ts --exclude=*.spec.ts --exclude-dir=test --exclude-dir=__tests__ . | grep -v "your-super-secret" | grep -v "change-this"; then
            report_finding "JWT Secret (non-example)" "$(grep -rn "JWT_SECRET\s*=\s*['\"][^'\"]*['\"]" "${GREP_EXCLUDES[@]}" --exclude=.env.example --exclude=*.yml --exclude=*.test.ts --exclude=*.spec.ts --exclude-dir=test --exclude-dir=__tests__ . | grep -v "your-super-secret" | grep -v "change-this" | head -1)"
          fi
          
          # Scan for Stripe keys
          if grep -rn "sk_live_[0-9a-zA-Z]{24,}" "${GREP_EXCLUDES[@]}" .; then
            report_finding "Stripe Secret Key" "$(grep -rn "sk_live_[0-9a-zA-Z]{24,}" "${GREP_EXCLUDES[@]}" . | head -1)"
          fi
          
          # Scan for GitHub tokens
          if grep -rn "gh[pousr]_[0-9a-zA-Z]{36}" "${GREP_EXCLUDES[@]}" .; then
            report_finding "GitHub Token" "$(grep -rn "gh[pousr]_[0-9a-zA-Z]{36}" "${GREP_EXCLUDES[@]}" . | head -1)"
          fi
          
          # Scan for Slack tokens
          if grep -rn "xox[baprs]-[0-9a-zA-Z-]+" "${GREP_EXCLUDES[@]}" .; then
            report_finding "Slack Token" "$(grep -rn "xox[baprs]-[0-9a-zA-Z-]+" "${GREP_EXCLUDES[@]}" . | head -1)"
          fi
          
          # Scan for Sentry DSN
          if grep -rn "https://[a-f0-9]{32}@[a-z0-9\-]+\.ingest\.sentry\.io" "${GREP_EXCLUDES[@]}" .; then
            report_finding "Sentry DSN" "$(grep -rn "https://[a-f0-9]{32}@[a-z0-9\-]+\.ingest\.sentry\.io" "${GREP_EXCLUDES[@]}" . | head -1)"
          fi
          
          # Check for .env files in git (should be gitignored)
          TRACKED_ENV="$(git ls-files | grep -E "\.env$|\.env\.local$|\.env\.production$" | grep -v '^docs/legacy/' || true)"
          if [ -n "$TRACKED_ENV" ]; then
            echo "‚ùå FOUND: .env file committed to git"
            echo "$TRACKED_ENV"
            echo ""
            ERRORS_FOUND=1
          fi
          
          # Exit with error if any secrets found
          if [ $ERRORS_FOUND -eq 1 ]; then
            echo "‚ùå Secrets or sensitive data detected!"
            echo ""
            echo "Please remove sensitive data before committing."
            echo "Use environment variables and .env files (which should be in .gitignore)."
            echo ""
            echo "See docs/RUNBOOK.md for security best practices."
            exit 1
          else
            echo "‚úÖ No secrets detected in custom pattern scan"
          fi

  check-env-examples:
    name: Verify .env.example Files
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for .env.example files
        run: |
          echo "üîç Checking for .env.example files..."
          
          # Expected .env.example files
          EXPECTED_FILES=(
            "apps/web/.env.example"
            "apps/api/.env.example"
            "apps/socket/.env.example"
          )
          
          MISSING_FILES=0
          
          for file in "${EXPECTED_FILES[@]}"; do
            if [ ! -f "$file" ]; then
              echo "‚ùå Missing: $file"
              MISSING_FILES=1
            else
              echo "‚úÖ Found: $file"
              
              # Check that .env.example doesn't contain real secrets
              if grep -q "AKIA[0-9A-Z]{16}" "$file"; then
                echo "‚ùå $file contains what looks like a real AWS key!"
                MISSING_FILES=1
              fi
              
              if grep -q "sk_live_" "$file"; then
                echo "‚ùå $file contains what looks like a real Stripe key!"
                MISSING_FILES=1
              fi
            fi
          done
          
          if [ $MISSING_FILES -eq 1 ]; then
            echo ""
            echo "‚ùå .env.example file issues detected"
            exit 1
          else
            echo ""
            echo "‚úÖ All .env.example files present and valid"
          fi

  # Summary job
  secrets-check-summary:
    name: ‚úÖ Secrets Scan Complete
    runs-on: ubuntu-latest
    needs: [gitleaks, trufflehog, custom-patterns, check-env-examples]
    if: always()

    steps:
      - name: Check all scans passed
        run: |
          if [ "${{ needs.gitleaks.result }}" != "success" ] || \
             [ "${{ needs.trufflehog.result }}" != "success" ] || \
             [ "${{ needs.custom-patterns.result }}" != "success" ] || \
             [ "${{ needs.check-env-examples.result }}" != "success" ]; then
            echo "‚ùå Some secret scans failed or detected issues"
            echo ""
            echo "Please review the scan results above and remove any secrets."
            echo "Refer to docs/RUNBOOK.md for security best practices."
            exit 1
          fi
          echo "‚úÖ All secret scans passed - no secrets detected!"

      - name: Post security notice
        if: github.event_name == 'pull_request' && success()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'üîê **Security Scan Passed**\n\nNo secrets detected:\n- ‚úÖ Gitleaks scan\n- ‚úÖ TruffleHog scan\n- ‚úÖ Custom pattern scan\n- ‚úÖ .env.example validation'
            })
